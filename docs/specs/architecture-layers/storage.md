# Storage Module

## Overview

The **Storage** module is the data persistence layer of the PaperProfit trading platform, providing a comprehensive database schema and data access layer for all trading-related operations. Built on SQLAlchemy ORM with SQLite as the primary database, this module handles everything from account management to market data storage.

## Architecture

The Storage module follows a layered architecture:

### 1. **Models Layer** (`models.py`)
SQLAlchemy ORM models defining the database schema with relationships and constraints.

### 2. **Database Layer** (`database.py`)
Database connection management, session handling, and engine configuration.

### 3. **Repository Layer** (`repositories.py`)
Data access objects (DAOs) providing CRUD operations and business logic encapsulation.

### 4. **Migration Layer** (`migrate.py` and `migration/`)
Database migration scripts for schema evolution and version control.

## Core Data Models

### Account Management
- **Account**: Virtual trading accounts with cash balances and strategies
- **AccountSummary**: Historical snapshots of account performance metrics
- **Position**: Current holdings in accounts with unrealized P&L
- **Trade**: Completed trade history with realized P&L calculations

### Market Data
- **Instrument**: Stock symbols and basic company information
- **MarketData**: OHLCV (Open, High, Low, Close, Volume) time-series data
- **TechnicalIndicator**: Calculated technical analysis metrics (SMA, RSI, MACD, etc.)
- **NewsSentiment**: News articles with sentiment analysis scores

### Trading Operations
- **Order**: Trading orders (market, limit, stop) with execution status
- **TradingSignal**: Buy/sell/hold signals generated by strategies
- **Strategy**: Trading strategy definitions and parameters

### System Management
- **Setting**: Application configuration and API keys
- **SystemLog**: Audit trail and debugging logs

## Key Features

### Comprehensive Data Modeling
- **Financial Precision**: DECIMAL types with appropriate precision for financial calculations
- **Temporal Data**: Timestamp tracking for all market data and transactions
- **Relationships**: Proper foreign key relationships with cascading operations
- **Unique Constraints**: Prevention of duplicate data entries
- **Soft Deletes**: `is_active` flags for non-destructive deletions

### Repository Pattern
- **Data Abstraction**: Separation of data access from business logic
- **Type Safety**: Strongly typed return values and parameters
- **Transaction Management**: Proper session handling and error recovery
- **Query Optimization**: Efficient database queries with appropriate indexing

### Migration Support
- **Version Control**: Sequential migration scripts for schema evolution
- **Rollback Support**: Ability to revert to previous schema versions
- **Data Preservation**: Migration scripts that preserve existing data
- **Automated Deployment**: Integration with application startup

## Database Schema Highlights

### Account-Centric Design
- Each account can have multiple positions and trades
- Accounts are associated with trading strategies
- Portfolio value calculated from positions and cash balance

### Time-Series Optimization
- Market data stored with timestamp and interval granularity
- Technical indicators linked to specific market data points
- Efficient querying for historical analysis

### Trading Workflow Support
- Order lifecycle tracking (pending → filled → cancelled)
- Position management with average entry price calculation
- P&L tracking (both unrealized and realized)

## API Integration

The Storage module underpins all API operations through dependency injection:
```python
from storage.database import get_db
from storage.repositories import RepositoryFactory

@app.get("/api/accounts")
async def get_all_accounts(db: Session = Depends(get_db)):
    account_service = AccountService(db)
    accounts = account_service.get_all_accounts()
    # ...
```

## Repository Factory Pattern

Centralized access to all repositories:
```python
class RepositoryFactory:
    def __init__(self, session: Session):
        self.session = session
        self.accounts = AccountRepository(session)
        self.instruments = InstrumentRepository(session)
        self.strategies = StrategyRepository(session)
        self.orders = OrderRepository(session)
        self.positions = PositionRepository(session)
        self.trades = TradeRepository(session)
        self.settings = SettingRepository(session)
        self.trading_signals = TradingSignalRepository(session)
```

## Purpose

The Storage module serves as the single source of truth for all PaperProfit data, ensuring data integrity, consistency, and reliability. Its well-designed schema supports complex trading operations while maintaining performance for real-time trading scenarios. The modular repository pattern allows for easy testing, maintenance, and evolution of the data layer as the platform grows.